- name: create required directories
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - /etc/cni/net.d
    - /opt/cni/bin
    - /opt/containerd
    - /var/lib/kubelet
    - /var/lib/kube-proxy
    - /var/lib/kubernetes
    - /var/run/kubernetes
    - /etc/kubernetes/manifests
    - /etc/containerd

- name: Install OS Dependencies
  ansible.builtin.apt:
    name: "{{ item }}"
    update_cache: yes
  loop: "{{ dependencies }}"

- name: Set node subnet from inventory
  ansible.builtin.set_fact:
    node_subnet: "{{ hostvars[inventory_hostname].pod_cidr }}"
  when: hostvars[inventory_hostname].pod_cidr is defined

- name: Render 10-bridge.conf
  ansible.builtin.template:
    src: 10-bridge.conf.j2
    dest: "/home/{{ ssh_target_user }}/10-bridge.conf"
    owner: root
    group: root
    mode: '0644'

##################################################
# Download, Extract, and Install Binaries
##################################################

- name: "Download {{ item.name }}""
  ansible.builtin.get_url:
    url: "{{ item.url }}"
    dest: /opt/
  loop: "{{ binaries }}"

- name: Extract {{ item.name }}
  ansible.builtin.unarchive:
    src: /opt/
    dest: "{{ item.dest }}"
    mode: a+x
    remote_src: yes
  loop: "{{ binaries }}"
  when: item.archive is defined

- name: Delete local {{ item.name }}
  ansible.builtin.file:
    path: "/opt/{{ item.name }}"
    state: absent
  loop: "{{ binaries }}"
  loop_control:
    label: "{{ item }}"


# - name: Copy Kubelet configs
#   ansible.builtin.copy:
#     src: "{{ item }}"
#     dest: "/home/{{ ssh_target_user }}/"
#     owner: root
#     group: root
#     mode: '0644'
#   loop: "{{ configs }}"
#   loop_control:
#     label: "{{ item }}"

# - name: Copy Kubelet services
#   ansible.builtin.copy:
#     src: "{{ item }}"
#     dest: "/home/{{ ssh_target_user }}/"
#     owner: root
#     group: root
#     mode: '0644'
#   loop: "{{ services }}"
#   loop_control:
#     label: "{{ item }}"
